

# 面向业务的消息服务设计

## 面临的问题

当前电商平台采用了微服务架构，服务之间依赖较重，耦合度较高。



## 消息队列解决方案

消息队列的作用：削峰填谷、异步、解耦。

![image-20201203172036177](https://technotes.oss-cn-shenzhen.aliyuncs.com/2021/image-20201203172036177.png)

直接使用消息队列将面临以下问题：

1. 开发成本大：开发团队成员都需要对消息队列如 Kafka 技术有一定的了解，并且还需要关注连接消息队列的一些配置；
2. 管理难度大：各团队都使用一个消息队列，其中一个团队使用不当时，例如创建了很多个 topic，造成资源浪费；
3. 监控难度大：当前只有对 Kafka 集群简单的监控功能；
4. 运维困难：遇到线上消息没有消费时，很难排查问题，无从下手；
5. 升级难度大：Kafka-Client 需要升级时，涉及到服务太多，导致升级成本高；

## 消息服务解决方案

### 面向业务的消息服务

使用消息队列，那对团队的要求是至少要有一个人对这项技术有所了解，这其实是一种面向技术的架构。而我们期望提供的解决方案是一种以业务为重心的，面向服务的架构。

例如，我们期望通过很简单的方式就能接入消息服务，期望通过很简单的调用，就能发送消息、接收消息。

```java
// 发送消息
EventPublisher.publish(new OrderCreated());
```

```java
// 接收消息
@EventHandler(topic = "order", consumerGroup = "consumer-group1")
public class OrderMessageHandler {
    public void handle(OrderCreated orderCreated) {
        System.out.println("receive message: " + orderCreated);
    }
}
```

这样对消息的使用方来说，是很友好的。

### 架构设计

面对上面问题，采用消息总线服务的方式进行优化。

![image-20230218150647472](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230218150647472.png)

消息服务隐藏了消息发送、必送必达、路由、分组、过滤、存储、高可用等一系列问题。

### 消息流转过程

![image-20230218162013959](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230218162013959.png)





### 消息结构

Header：通用数据，包含 message ID, timstamp 等。

Body：业务相关的消息体。



### 高可用设计

补偿机制：失败重试、自动补偿、手动补偿。



### 监控与告警



## 落地与实践

### 源码篇

原理图示。专篇细讲

### 数据库篇

表结构图示。专篇细讲

## 开源

