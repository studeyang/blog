> 参考文档：
>
> - https://zhishiku.casstime.com/pages/viewpage.action?pageId=70887297
> - https://gitlab.casstime.net/ec-infra/flowhub/blob/master/README.md

## 一、匹配策略

### 1.1 query-string 策略

满足配置的 URL 规则（eq 等于、pattern 正则匹配），并且参数匹配配置的 condition 条件，则分流到该规则对应的 environment。

例如：

- url = /api
- condition = eq
- => env_id = 1

### 1.2 header 策略

管理员配置对应的请求头、值以及条件（eq 等于、contain 包含、pattern 正则匹配），如果该请求头的值匹配成功，则分流到该规则对应的 environment。

例如：

- key = user-agent
- expression = eq （eq 等于，contain）
- value = Mozilla/5.0
- => env_id = 1

### 1.3 用户策略

用户维度为精确匹配，包括 username 和 representativeCompanyId，从 cookie 中的 `security_context` 中解析得到，若用户或公司 id 匹配成功， 则分流到该规则对应的 environment。

例如：

- key = username
- expression = eq
- value = mandy
- => env_id = 1

### 1.4 区域策略

通过客户端 IP 识别不同的区域，通过配置省市分流到不同的后端服务器。如：可配置云南省的流量到达环境 A，配置广东省深圳市的流量到达环境 B。

### 1.5 权重策略

配置后端服务器权重比例，根据权重比例分流到不同的后端服务器，如：环境 A：127.0.0.1:8001 = 3，环境 B：127.0.0.1:8002 = 2，则 60% 流量到达环境A，40% 流量到达环境B。

基于动态 upstream 实现：https://github.com/openresty/lua-resty-balancer。

支持 2 种权重分配算法：

- chash：(默认值)，针对同一个客户端的请求分流到同一个后端服务器。
- roundrobin：根据权重比例将请求随机分配到后端的服务器。

### 1.6 策略优先级

以上策略的匹配优先级如下图所示：

![image-20230419143920104](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419143920104.png)

## 二、缓存方案

Nginx 的共享内存不支持 table 类型的数据存储，引入 mlcache 做本地缓存。github 地址：https://github.com/thibaultcha/lua-resty-mlcache

```
一级缓存L1: lrucache
二级缓存L2: redis
```

原理：查询时会先从 L1 获取值，如果取到，直接返回，否则从 L2 获取值，获取到值返回，并将值写入 L1 缓存。如果未获取到，就会访问 redis 获取数据，将获取到的值写入 L2 缓存，再根据 L1_serializer 将值提升存入到 L1 缓存。

### 3.1 query-string 分流策略缓存

存放全匹配的 url：

```
hset "querystring_rule:eq" url json
```

存放正则匹配的url：

```
hset "querystring_rule:eq" url json
```

示例：

```
hset "querystring_rule:eq" "/api" "[{\"url\": \"/api\", \"condition\": \"apiName=cassec.shipment.waybill.status\", \"environment_id\": 1}, {\"url\": \"/api\", \"condition\": \"apiName=cassec.shipment.waybill.trace\", \"environment_id\": 1}]"
```

说明：上述配置表示，当 url 为 `/api`，并且请求参数为 `apiName=cassec.shipment.waybill.status` 或者 `apiName=cassec.shipment.waybill.trace` 时，分流到 id 为 1 的环境。

### 3.2 header 分流策略缓存

```
hset "header_rule" header_key json
```

示例：

```
hset "header_rule" "user-agent" "[{\"key\":\"user-agent\",\"value\":\"Mozilla/5.0\",\"expression\":\"contain\",\"environment_id\": 2}]"
```

说明：上述配置表示，当请求头 user-agent 的值包含 Mozilla/5.0 时，分流到 id 为 2 的环境。

### 3.3 用户维度分流策略缓存

```
hset key value environment_id
```

示例：

```
hset username admin 1
hset companyId 10422 1
```

说明：上述配置表示，当 username 为 admin 或 companyId 为 10422 时，分流到 id 为 1 的环境。

### 3.4 区域 (IP) 策略

示例：

```
# 云南省的流量都分流到环境 1
hset area:云南 ALL 1
# 广东深圳的流量分流到环境 2
hset area:广东 深圳 2
```

### 3.5 权重策略

```
# 权重策略配置
hset "weight_rule" "balancer_algorithm" 1
```

配置权重算法, 0 代表 chash，1 代表 roundrobin。

```
# roundrobin 算法
hset "weight_rule" "roundrobin" "[{\"environment_id\":  8001, \"weight\": 60}, {\"environment_id\": \"8002\", \"weight\": 40}]"
# chash 算法
hset "weight_rule" "chash" "[{\"environment_id\": 8001, \"weight\": 60}, {\"environment_id\": 8002, \"weight\": 40}]"
```

## 三、表结构

> 线上未使用关系型数据库

### 1.1 strategy_config

| 字段名               | 字段类型 | 描述               |
| -------------------- | -------- | ------------------ |
| id                   |          | 序号               |
| version              |          | 版本标识           |
| has_user_flow        |          | 是否开启用户分流   |
| has_querystring_flow |          | 是否开启URL分流    |
| has_header_flow      |          | 是否开启请求头分流 |
| has_weights_flow     |          | 是否开启权重分流   |
| created_at           |          | 分流策略创建时间   |
| is_enable            |          | 是否生效           |
| creator              |          | 创建人             |
| is_delete            |          |                    |
| env_type             |          | 环境类型           |
| is_load              |          | 是否加载           |
| is_apply             |          | 是否应用           |

> 注：这张表扩展性不高。新加一种灰度策略，就要新加一个字段。

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419113427127.png)

### 1.2 strategy_rule_querystring

| 字段名         | 字段类型 | 描述                        |
| -------------- | -------- | --------------------------- |
| id             |          | 序号                        |
| config_id      |          | 配置记录ID                  |
| url            |          | 需要分流的地址              |
| condition      |          | 请求参数条件多个条件用&连接 |
| environment_id |          | 符合条件时转发的环境        |
| is_enable      |          | 是否生效                    |
| created_at     |          | 创建时间                    |
| creator        |          | 创建人                      |
| is_delete      |          |                             |
| expression     |          | 表达式                      |

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419112959235.png)

### 1.3 strategy_rule_user

| 字段名         | 字段类型 | 描述 |
| -------------- | -------- | ---- |
| id             |          |      |
| config_id      |          |      |
| key            |          |      |
| value          |          |      |
| expression     |          |      |
| environment_id |          |      |
| is_enable      |          |      |
| created_at     |          |      |
| creator        |          |      |
| is_delete      |          |      |

### 1.4 strategy_rule_header

| 字段名               | 字段类型 | 描述 |
| -------------------- | -------- | ---- |
| id                   |          |      |
| is_delete            |          |      |
| creator              |          |      |
| created_at           |          |      |
| strategy_rule_header |          |      |
| is_enable            |          |      |
| expression           |          |      |
| environment_id       |          |      |
| value                |          |      |
| key                  |          |      |
| config_id            |          |      |

### 1.5 environment

| 字段名        | 字段类型 | 描述         |
| ------------- | -------- | ------------ |
| id            |          | 编号         |
| name          |          | 环境名称     |
| host          |          | 环境 IP 地址 |
| port          |          | 服务端口     |
| description   |          | 描述信息     |
| is_enable     |          | 是否生效     |
| user_passport |          | 密码         |
| user_name     |          | 用户名       |
| created_at    |          | 创建时间     |
| creator       |          | 创建人       |
| is_delete     |          | 是否删除     |
| env_type      |          | 环境类型     |

## 四、性能测试

### 4.1 测试场景

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419151830440.png)

硬件规格：

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419155528424.png)

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419155601889.png)

场景一：模拟大批用户访问 nginx 时根据配置的规则，将不同请求分配到不同服务器，然后返回响应（开始压测前数据未缓存）；

场景二：模拟大批用户访问 nginx 时根据配置的规则，将不同请求分配到不同服务器，然后返回响应（压测前已缓存数据）；

场景三：模拟高峰期大批用户访问 nginx 时切换策略，切换策略开关；

### 4.2 压力策略

规则总数：100226 条，具体如下：

- URL 策略配置：URL 匹配规则数量 120 条，全量匹配 61 条，正则匹配 60 条；
- Header 策略配置： 请求头匹配规则数量：106 条，全量匹配占 37 条，包含匹配，正则匹配各占 35 条；
- 用户策略配置：用户匹配规则数量 100000 条，username 占 500001，companyId 占 50000 条；

缓存大小配置(/usr/local/openresty/nginx/lua/strategy.lua) ：cache_key_size = 100000

### 4.3 测试步骤

1. 先进行基准测，探测服务器最佳性能；
2. 然后进行稳定性测试，与此同时，记录服务器后台相关性能数据；

### 4.4 测试结果

**场景一：55 个用户，持续时间：约 30 分钟。**

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419153429786.png)

TPS 曲线图：

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419153638065.png)

nginx 服务：

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419153821242.png)

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419153905405.png)

后端服务 1：

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419153931766.png)

后端服务 2：

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419153957634.png)

Redis 服务：

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419154020499.png)

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419154032457.png)

结果分析：

- tps 曲线稍微有点波动，但整体还算稳定, 99%的响应时间不超过 21 毫秒，错误率为 0，压测请求平均 TPS 达 6862.75
- Nginx 服务内存使用变化不大，磁盘 IO 开销很小，CPU 使用很高，近 100%，可能为当前性能瓶颈
- 后端服务，redis 服务，CPU，内存使用都不高，暂不构成瓶颈

**场景二：55 个用户，持续时间：约 40 分钟**

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419154305748.png)

TPS 曲线图：

![image-20230419154408119](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419154408119.png)

nginx 服务：

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419154532519.png)

后端服务 1：

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419154548749.png)

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419154601484.png)

后端服务 2：

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419154611554.png)

结果分析：

- 相比无缓存时，tps 曲线波动较小，更稳定，压测请求 TPS 稍微高一些，达 7766

**场景三：55 个用户，持续时间：约 1 小时 05 分钟**

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419154744303.png)

TPS 曲线图：

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419154843059.png)

nginx 服务：

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419154941456.png)

后端服务 1：

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419154958283.png)

后端服务 2：

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419155011403.png)

![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/image-20230419155030174.png)

结果分析：

- 相比场景 1，平均 TPS 会更高一些，这个是因为策略关闭，数据清理，导致，从控制台输出日志看，TPS 其实是差不多的
- 服务性能和场景中服务性能相近，CPU 使用会稍微低一点
- 压测工具结果来看，部分请求有出错，这个可以忽略，用例设计如此

### 4.5 测试结论

- 目前生产环境 QPS 为 3000 左右，所以，从当前压测 TPS（有缓存）来看，能满足当前业务性能需求
- 程序容错能力较好，支持高峰期切换策略、策略开关（不推荐）
- 不排除工具自身存在缺陷，以上结论仅供参考。

