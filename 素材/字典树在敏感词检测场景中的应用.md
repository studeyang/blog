---
permalink: 2023/11.html
title: 字典树在敏感词检测场景中的应用
date: 2023-06-08 09:00:00
tags: 数据结构与算法
cover: 
thumbnail: 
categories: technotes
toc: true
description: 文章模板，后面的文章可以参考这个模板的参数
---

传统的消息队列对业务方提出了更高的要求，我们期望提供的是一种以业务为重心的，面向服务的解决方案。

<!-- more -->

## 一、场景介绍



## 二、什么是字典树



### 2.1 



### 2.2 字典树在开源工具 Hutool 中的实现

新建字典树

```java
WordTree wordTree = new WordTree();
```

构建数据

```java
public WordTree addWords(Collection<String> words) {
	if (false == (words instanceof Set)) {
		words = new HashSet<>(words);
	}
	for (String word : words) {
		addWord(word);
	}
	return this;
}

public WordTree addWord(String word) {
	final Filter<Character> charFilter = this.charFilter;
	WordTree parent = null;
	WordTree current = this;
	WordTree child;
	char currentChar = 0;
	final int length = word.length();
	for (int i = 0; i < length; i++) {
		currentChar = word.charAt(i);
		if (charFilter.accept(currentChar)) {//只处理合法字符
			child = current.get(currentChar);
			if (child == null) {
				//无子类，新建一个子节点后存放下一个字符
				child = new WordTree();
				current.put(currentChar, child);
			}
			parent = current;
			current = child;
		}
	}
	if (null != parent) {
		parent.setEnd(currentChar);
	}
	return this;
}
```

例如：红领巾，红河构建树后为： 

```
   红
  / \
 领  河
 /
巾
```

```java
wordTree.isMatch("红色"); // false
wordTree.isMatch("红领"); // false
wordTree.isMatch("红领巾"); // true
```



## 三、字典树的应用



```java
package com.hncboy.chatgpt.base.handler;

import cn.hutool.dfa.WordTree;
import cn.hutool.extra.spring.SpringUtil;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.google.common.cache.CacheBuilder;
import com.google.common.cache.CacheLoader;
import com.google.common.cache.LoadingCache;
import com.hncboy.chatgpt.base.domain.entity.SensitiveWordDO;
import com.hncboy.chatgpt.base.enums.EnableDisableStatusEnum;
import com.hncboy.chatgpt.base.mapper.SensitiveWordMapper;
import lombok.extern.slf4j.Slf4j;
import org.jetbrains.annotations.NotNull;

import java.util.Collections;
import java.util.List;
import java.util.Objects;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

/**
 * @author hncboy
 * @date 2023-3-28
 * 敏感词处理
 */
@Slf4j
public class SensitiveWordHandler {

    private static final String CACHE_KEY = "wordTree";

    /**
     * 敏感词缓存
     */
    private static final LoadingCache<String, WordTree> CACHE = CacheBuilder.newBuilder()
            // 设置并发级别为 CPU 核心数
            .concurrencyLevel(Runtime.getRuntime().availableProcessors())
            // 容量为 1
            .initialCapacity(1)
            // 过期时间为 12 小时
            .expireAfterWrite(12, TimeUnit.HOURS)
            .build(new CacheLoader<>() {

                @Override
                public @NotNull WordTree load(@NotNull String s) {
                    log.warn("开始构建敏感词树");
                    WordTree wordTree = new WordTree();
                    SensitiveWordMapper sensitiveWordMapper = SpringUtil.getBean(SensitiveWordMapper.class);
                    List<SensitiveWordDO> sensitiveWords = sensitiveWordMapper.selectList(new LambdaQueryWrapper<SensitiveWordDO>()
                            .select(SensitiveWordDO::getWord)
                            .eq(SensitiveWordDO::getStatus, EnableDisableStatusEnum.ENABLE));
                    log.warn("查询数据库，敏感词数量为：{} 个", sensitiveWords.size());
                    // 生成关键词树
                    wordTree.addWords(sensitiveWords.stream().map(SensitiveWordDO::getWord).collect(Collectors.toSet()));
                    return wordTree;
                }
            });

    /**
     * 检查敏感词
     *
     * @return 敏感词列表
     */
    public static List<String> checkWord(String content) {
        WordTree wordTree = null;
        try {
            wordTree = CACHE.get(CACHE_KEY);
        } catch (Exception e) {
            log.error("获取敏感词树失败", e);
        }
        if (Objects.isNull(wordTree)) {
            return Collections.emptyList();
        }
        return wordTree.matchAll(content, -1, false, false);
    }
}
```



```java
public class SensitiveWordEmitterChain {
    @Override
    public void doChain(ChatProcessRequest request, ResponseBodyEmitter emitter) {
        List<String> prompts = SensitiveWordHandler.checkWord(request.getPrompt());
        if (CollectionUtil.isNotEmpty(prompts)) {
            chatReplyMessageVO.setText(StrUtil.format("包含敏感词{}", prompts));
            emitter.send(ObjectMapperUtil.toJson(chatReplyMessageVO));
            emitter.complete();
            return;
        }
    }
}
```



![](https://technotes.oss-cn-shenzhen.aliyuncs.com/2023/202303052135542.gif)

## 封面



## 相关文章

也许你对下面文章也感兴趣。

- [学习分享（第3期）：你所理解的架构是什么？](https://mp.weixin.qq.com/s/ao9-DW3tXw25AW6D96m5LQ)

